{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "StreamBucketARN": {
            "Type": "String",
            "Default": "arn:aws:s3:::olien-stream2",
            "Description": "Destination S3 Bucket for firehose"
        }
    },
    "Resources" : {
        "S3DeliveryStream": {
            "Type": "AWS::KinesisFirehose::DeliveryStream",
            "Properties": {
                "S3DestinationConfiguration" : {
                    "BucketARN": { "Ref" : "StreamBucketARN" },
                    "BufferingHints": {
                        "IntervalInSeconds": "60",
                        "SizeInMBs": "50"
                    },
                    "CompressionFormat": "UNCOMPRESSED",
                    "Prefix": "firehose/",
                    "RoleARN": { "Fn::GetAtt" : ["FirehoseLambdaCloudwatchRole", "Arn"] }
                }
            }
        },
        "FirehoseLambdaCloudwatchRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "firehose.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "sts:ExternalId":"138831098359"
                                }
                            }
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "S3BucketAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": {
                                "Effect": "Allow",
                                "Action": [
                                    "s3:AbortMultipartUpload",
                                    "s3:GetBucketLocation",
                                    "s3:GetObject",
                                    "s3:ListBucket",
                                    "s3:ListBucketMultipartUploads",
                                    "s3:PutObject"
                                ],
                                "Resource": [
                                    "arn:aws:s3:::olien-stream2",
                                    "arn:aws:s3:::olien-stream2/*"
                                ]
                            }
                        }
                    },
                    {
                        "PolicyName": "LambdaExecution",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": {
                                "Effect": "Allow",
                                "Action": [
                                    "lambda:InvokeFunction",
                                    "lambda:GetFunctionConfiguration"
                                ],
                                "Resource": [
                                    "arn:aws:lambda:us-west-2:138831098359:function:*"
                                ]
                            }
                        }
                    },
                    {
                        "PolicyName": "LambdaBasicExecution",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "logs:CreateLogGroup",
                                    "Resource": "arn:aws:logs:us-west-2:138831098359:*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        "arn:aws:logs:us-west-2:138831098359:log-group:/aws/lambda/test:*"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "AmazonKinesisFullAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Action": [
                                        "firehose:*"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        }
    }
}